import React, {useContext, useEffect, useState} from "react";
import {Redirect} from "react-router-dom";
import useFetch from "hooks/useFetch";
import {CurrentUserContext} from 'contexts/currentUser'
import BackendErrorMessages from 'pages/signIn/components/backendErrorMessages'
import {modalContext} from 'contexts/modalContext'

const SignUp = props => {
    const apiUrl = '/auth/signUp'
    let { modalContent, handleModal, modal } = useContext(modalContext);

    const [email, setEmail] = useState('')
    const [password, setPassword] = useState('')
    const [passwordConfirm, setPasswordConfirm] = useState('')
    const [fio, setFio] = useState('')
    const [phone, setPhone] = useState('')
    const [isSuccessfulSubmit, setIsSuccessfulSubmit] = useState(false)
    const [{response, isLoading, error}, doFetch] = useFetch(apiUrl)

    const [, setCurrentUserState] = useContext(CurrentUserContext)
    console.log('signUp component was mounted')

    const handleSubmit = event => {
        event.preventDefault()
        const user = {email, password, fio, phone}
        doFetch({
            method: 'post',
            data: {
                ...user
            }
        })
    }

    useEffect(() => {
        if (!response) {
            return
        }

        setIsSuccessfulSubmit(true)
        handleModal()
    }, [response, setCurrentUserState])


    if (isSuccessfulSubmit) {
        //handle second modal
        return <Redirect to='/'/>
    }

    return (
        <>
            <div className="modal modal_reg modal_in_css">
                <div className="modal_bg"/>
                <div className="modal_box">
                    <img onClick={() => handleModal()} className="close mod_close" src="/img/close.svg" alt='close' />
                        <h2>Регистрация</h2>
                        <form onSubmit={handleSubmit} id='signUpForm'>
                            {error && <BackendErrorMessages backendErrors={error.errors}/>}
                            <p>Ваше ФИО</p>
                            <input
                                type="text"
                                className="in_tel"
                                placeholder="Фамилия Имя Отчество"
                                value={fio}
                                onChange={e => setFio(e.target.value)}
                            />
                                <p>Номер телефона</p>
                                <input
                                    type="tel"
                                    className="in_tel"
                                    placeholder="+7 (987) 144-14-44"
                                    value={phone}
                                    onChange={e => setPhone(e.target.value)}
                                />
                                    <p>Email</p>
                                    <input
                                        type="email"
                                        className="in_tel"
                                        placeholder="ivanov@mail.ru"
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                    />
                                        <p>Пароль</p>
                                        <div className="password">
                                            <input
                                                type="password"
                                                id="password-input"
                                                placeholder="Введите ваш пароль"
                                                value={password}
                                                onChange={e => setPassword(e.target.value)}
                                            />
                                                <a href="#" className="password-control"/>
                                        </div>
                                        <p>Повторите пароль</p>
                                        <div className="password">
                                            <input
                                                type="password"
                                                id="password-input"
                                                placeholder="Подтвердите ваш пароль"
                                                value={passwordConfirm}
                                                onChange={e => setPasswordConfirm(e.target.value)}
                                            />
                                                <a href="#" className="password-control"/>
                                        </div>
                                        <input
                                            type="submit"
                                            className="submit"
                                            value="Зарегистрироваться"
                                            disabled={isLoading}
                                        />
                        </form>
                        <p className="modal_in_t1">При входе вы потверждаете согласие <a>с условиями использования
                            BESTforCARS</a> и <a>политикой о данных пользователей</a>.</p>
                </div>
            </div>
        </>
    )
}

export default SignUp
