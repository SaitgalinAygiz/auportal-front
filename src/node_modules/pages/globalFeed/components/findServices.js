import React, {useEffect, useState} from 'react'
import useFetch from 'hooks/useFetch'
import Loading from "components/loading";
import ErrorMessage from "components/errorMessage";

const FindServices = params => {
    const [apiUrl, setApiUrl] = useState(`/services/findByCategory?categoryTitle=${params.categoryType}`)
    const [{response, isLoading, error}, doFetch] = useFetch(apiUrl)
    const [checkedItems, setCheckedItems] = useState([])

    useEffect(() => {
        params.setArrayFilterServices(checkedItems)
    }, [checkedItems])

    useEffect(() => {
        setApiUrl(`/services/findByCategory?categoryTitle=${params.categoryType}`)
        doFetch()
    }, [params.categoryType, doFetch])

    const handleChange = event => {
        const inputValue = event.target
        const innerText = inputValue.parentElement.innerText.split('(')[0]
        if (event.target.checked === true) {
            setCheckedItems([
                    ...checkedItems,
                    innerText
                ]
            )
        } else {
            const index = checkedItems.indexOf(innerText)
            checkedItems.splice(index, 1)
            setCheckedItems(checkedItems)
        }
    }

    useEffect(() => {
        doFetch()
    }, [doFetch])

    useEffect(() => {
        if (response == null)
            return


        console.log('DEBIL')
        console.log(response)
        console.log('das')
    }, [response])

    return (
        <>
            {isLoading && <Loading/>}
            {error && <ErrorMessage/>}

            {!isLoading && response && params.categoryType === 'service' && (
                <ul style={{gridTemplateColumns: `repeat(${params.categoryType === 'service' ? '4' : '6'}, 1fr)`}}>
                    {
                        response.map((service, index) => (
                            <div key={index}>
                                <li>
                                    <label>
                                        <input onChange={handleChange} type='checkbox'/>
                                        <div>{service.title} ({service.count})</div>
                                    </label>
                                </li>
                            </div>
                        ))
                    }
                </ul>
            )}

            {!isLoading && response && params.categoryType === 'saleAutoParts' && (
                <>
                    <p style={{fontSize: '20px', marginBottom: '20px'}}>Легковые автомобили</p>

                    <ul style={{gridTemplateColumns: `repeat(${params.categoryType === 'service' ? '4' : '6'}, 1fr)`}}>
                        {
                            response.filter(service => service.autoType === 'passenger').map((service, index) => (
                                <div key={index}>
                                    <li>
                                        <label>
                                            <input onChange={handleChange} type='checkbox'/>
                                            <div>{service.title} ({service.count})</div>
                                        </label>
                                    </li>
                                </div>
                            ))
                        }
                    </ul>

                    <p style={{fontSize: '20px', marginBottom: '20px'}}>Грузовые автомобили</p>
                    <ul style={{gridTemplateColumns: `repeat(${params.categoryType === 'service' ? '4' : '6'}, 1fr)`}}>

                        {response.filter(service => service.autoType === 'truck').map((service, index) => (
                            <div key={index}>
                                <li>
                                    <label>
                                        <input onChange={handleChange} type='checkbox'/>
                                        <div>{service.title} ({service.count})</div>
                                    </label>
                                </li>
                            </div>
                        ))}

                    </ul>
                </>
            )}
        </>
    )
}

export default FindServices
