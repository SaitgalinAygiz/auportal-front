import React, {Fragment, useEffect, useState} from 'react'
import Feed from 'components/feed'
import Pagination from 'components/pagination'
import {getPaginator, paginationLimit} from "../../utils";
import {stringify} from "query-string";
import Loading from 'components/loading'
import ErrorMessage from 'components/errorMessage'
import useFetch from 'hooks/useFetch'
import SubAccount from "pages/globalFeed/components/subAccount";

const GlobalFeed = ({location, match}) => {
    const [searchConditions, setSearchConditions] = useState('')
    const {offset, currentPage} = getPaginator(location.search)
    const stringifiedParams = stringify({
        page: currentPage,
        limit: paginationLimit
    })

    const [apiUrl, setApiUrl] = useState(`/subAccount?${stringifiedParams}`)
    const [fetchServices, setFetchServices] = useState(`/services/all`)

    const [{response, isLoading, error}, doFetch] = useFetch(apiUrl)
    const [{servicesRes, resIsLoading, resError}, doFetchServices] = useFetch(fetchServices)
    const url = match.url


    useEffect(() => {
        doFetchServices()
        doFetch()
    }, [doFetchServices, doFetch, currentPage])


    useEffect(() => {
        setApiUrl(`/subAccount/selectWithQuery?${stringifiedParams}&conditions=${searchConditions}`)
        doFetch()
    }, [doFetch, searchConditions, currentPage])

    return (
        <section className="a1">
            <div className="container">
                <div className="a1c2">
                    <h2>Укажите какой ремонт нужно выполнить, отправьте заявку<br/>
                        во все автосервисы Уфы и выберите лучшие предложения по стоимости
                    </h2>
                    <a className="but1">Отправить заявку на просчет ремонта</a>
                </div>

                <div className="a1c3">
                    <div className="a1c3_row">
                        <div className="a1c3_item a1c3_drop">
                            <span>Все автосервисы</span>
                        </div>
                        <div className="a1c3_item a1c3_search">
                            <input
                                className="a1search"
                                type="search"
                                placeholder="Поиск по автозапчастям"
                                value={searchConditions}
                                onChange={e => setSearchConditions(e.target.value)}
                            />
                        </div>
                        <div className="a1c3_item a1c3_map">
                            <a className="list_spis active">Списком</a>
                            <a className="list_map">На карте</a>
                        </div>
                        <div className="a1c3_item a1c3_fil">
                            <span>По умолчанию</span>
                            <div className="a1c3_fil_drop">
                                <ul>
                                    <li>По умолчанию</li>
                                    <li>С рейтингом от 4 звезд</li>
                                    <li>Ближайшие ко мне</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div className="a1c3_drop_down">
                        <ul>
                            <input type="checkbox"/>
                            {servicesRes.map((serviceType, index) => (
                                <li>
                                    <label>
                                        serviceType.title
                                    </label>
                                </li>
                            ))}
                        </ul>
                        <a className="but1">Применить</a>
                    </div>
                </div>


                <div className="a1c1">
                    {isLoading && <Loading/>}
                    {error && <ErrorMessage/>}
                    {!isLoading && response && (
                        <Fragment>
                            <div className="title1">
                                <h2>Автозапчасти <span className="red">Toyota</span> в г. Уфа</h2>
                                <p>Найдено: {response.meta.totalItems} магазинов автозапчастей</p>
                            </div>
                            <div className="list_map_all">
                                <img src="/img/map.jpg"/>
                            </div>
                            <Feed subAccounts={response.items}/>
                            <Pagination
                                total={response.meta.totalItems}
                                limit={paginationLimit}
                                url={url}
                                currentPage={currentPage}
                            />
                        </Fragment>
                    )}
                </div>
            </div>

        </section>
    )
}

export default GlobalFeed


