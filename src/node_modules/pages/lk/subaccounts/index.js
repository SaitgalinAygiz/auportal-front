import React, {useEffect, useState} from 'react'
import useFetch from 'hooks/useFetch'
import ErrorMessage from "components/errorMessage";
import Loading from 'components/loading'
import {transformCategory, transformSubAccountType} from "../../../utils";
import {Link} from "react-router-dom";

const SubAccounts = () => {
    const [subAccountsApi, setSubAccountsApi] = useState('/subAccount/byAccount')
    const [{response, error, isLoading}, doFetch] = useFetch(subAccountsApi)
    const [subAccounts, setSubAccounts] = useState(null)

    useEffect(() => {
        if (response != null || subAccountsApi !== '/subAccount/byAccount') {
            return
        }

        doFetch()
    }, [doFetch])

    useEffect(() => {
        if (response == null || subAccountsApi !== '/subAccount/byAccount') {
            return
        }

        setSubAccounts(response)
    }, [response])

    const allSubAccountsClick = event => {
        const allEl = document.getElementById('allSubAccountsNavLi')
        allEl.classList.add('active')

        const servicesEl = document.getElementById('servicesNavLi')
        servicesEl.classList.remove('active')

        const autoPartsEl = document.getElementById('saleAutoPartsNavLi')
        autoPartsEl.classList.remove('active')

        setSubAccountsApi('/subAccount/byAccount')
        doFetch()
    }

    const subAccountsWithCategory = (event, category) => {
        const allEl = document.getElementById('allSubAccountsNavLi')
        allEl.classList.remove('active')

        switch (category) {
            case 'saleAutoParts':
                const autoEl = document.getElementById('saleAutoPartsNavLi')
                autoEl.classList.add('active')
                const servicesEl = document.getElementById('servicesNavLi')
                servicesEl.classList.remove('active')
                break
            case 'service':
                const autoPartsEl = document.getElementById('saleAutoPartsNavLi')
                autoPartsEl.classList.remove('active')
                const servEl = document.getElementById('servicesNavLi')
                servEl.classList.add('active')
                break
        }
        setSubAccountsApi('/subAccount/byAccountWithCategory?category=' + category)
        doFetch()
    }

    const categoryFilter = (categoryType) => {
        if (subAccounts == null)
            return

        return subAccounts.filter(subAccount => {
            return subAccount.category.title === categoryType
        })
    }

    const handleAddCompany = event => {
        //TODO: сделать линк на роут (компонент) addSubAccount
    }

    return (
        <section className="comp_block">
            <div className="container">
                <h1 className="title4">Мои компании</h1>
                <ul className="comp_meny">
                    <li
                        onClick={e => {
                            allSubAccountsClick(e)
                        }}
                        className="active"
                        id="allSubAccountsNavLi"
                    >
                        <a onClick={e => {
                            allSubAccountsClick(e)
                        }}>
                            Все компании {subAccounts && subAccounts.length}
                        </a>
                    </li>
                    <li
                        onClick={e => {
                            subAccountsWithCategory(e, 'saleAutoParts')
                        }}
                        id="saleAutoPartsNavLi"
                    >
                        <a onClick={e => {
                            subAccountsWithCategory(e, 'saleAutoParts')
                        }}>
                            Автозапчасти {subAccounts && categoryFilter('saleAutoParts').length}
                        </a>
                    </li>
                    <li onClick={e => {
                        subAccountsWithCategory(e, 'service')
                    }}
                        id='servicesNavLi'
                    >
                        <a onClick={e => {
                            subAccountsWithCategory(e, 'service')
                        }}>
                            Автосервисы {subAccounts && categoryFilter('service').length}
                        </a>
                    </li>
                </ul>
                <div className="comp_chec">
                    <input type="checkbox"/>
                    <div className="comp_drop">
                        <p>Выбрать действия</p>
                        <ul>
                            <li>Выбрать действия</li>
                            <li>Удалить</li>
                            <li>Остановить</li>
                            <li>Запустить</li>
                        </ul>
                    </div>
                </div>
                <div className="comp_row">
                    <Link to={'/lk/addSubAccount'} className="comp_plus" onClick={handleAddCompany}>
                        <div className="comp_plus_box">
                            <img src="/img/big_plus.svg" alt={'+'}/>
                            <h3>Добавить компанию</h3>
                        </div>
                    </Link>

                    {error && <ErrorMessage/>}
                    {response && (
                        <>
                            {response.length === 0 && (
                                <div className="title1">
                                    <h2>Не найдено</h2>
                                </div>
                            )}
                            {response.length !== 0 && (
                                <>
                                    {response.map((subAccount, index) => (
                                        <div key={index} className="comp_item">
                                            <div className="comp_item_hed">
                                                <input type="checkbox"/>
                                                <div className="comp_item_check"/>
                                                <h3 className="red">{transformSubAccountType(subAccount.status)}</h3>
                                                <a className="comp_item_delet">
                                                    <img src="/img/delet.svg" alt={'delete'}/></a>
                                                <a className="comp_item_rec"><img src="/img/rec.svg" alt={'rec'}/></a>
                                            </div>
                                            <div className="comp_item_main">
                                                <div className="comp_item_main_img">
                                                    <img
                                                        src={`http://localhost:3999/subaccount-photo/getSubAccountPhotos?subAccountId=${subAccount.id}`}
                                                        alt={'Загрузка'}/>
                                                </div>
                                                <div className="a1c1_item_tet">
                                                    <p className="a1c1_item_tet1">{transformCategory(subAccount.category.title)}</p>
                                                    <h3>{subAccount.title}</h3>
                                                    <a href="tel:+7 (347) 255-55-55">{subAccount.contacts.phoneNumber}</a>
                                                    <p className="a1c1_item_tet2">
                                                        ул. {subAccount.contacts.addresses[0].street} {subAccount.contacts.addresses[0].houseNumber}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="comp_item_foot">
                                                <h4>Срок размещения</h4>
                                                <div className="comp_item_foot_time">
                                                    <div className="comp_item_foot_time_load" style={{width: '100%'}}/>
                                                </div>
                                                <p>Осталось ∞ дней</p>
                                                <a className="but1">Продлить</a>
                                            </div>
                                        </div>
                                    ))}
                                </>
                            )}
                        </>
                    )}

                </div>
            </div>
        </section>
    )
}

export default SubAccounts
