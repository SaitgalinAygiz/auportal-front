import React, {useContext, useEffect, useState} from "react";
import {Router} from "react-router-dom";
import LkMenu from "pages/lk/menu";
import {CurrentUserContext} from "contexts/currentUser";
import useFetch from "hooks/useFetch";

const PersonalInfo = params => {

    const [currentUserState] = useContext(CurrentUserContext)
    const saveChanges = '/account/edit'
    const [{result, isLoading, error}, doFetch] = useFetch(saveChanges)

    const [firstName, setFirstName] = useState('')
    const [lastName, setLastName] = useState('')
    const [middleName, setMiddleName] = useState('')
    const [birthDate, setBirthDate] = useState('')
    const [email, setEmail] = useState('')
    const [phoneNumber, setPhoneNumber] = useState('')

    const [city, setCity] = useState('')
    const [address, setAddress] = useState('')
    const [driverLicenseSerial, setDriverLicenseSerial] = useState('')
    const [driverLicenseNumber, setDriverLicenseNumber] = useState('')

    useEffect(() => {
        const currUser = currentUserState.currentUser
        if (currUser == null) return
        setFirstName(currUser.firstName)
        setLastName(currUser.lastName)
        setMiddleName(currUser.middleName)

        setBirthDate(toIsoString(currUser.birthDate))

        setAddress(currUser.address)
        setEmail(currUser.email)
        setPhoneNumber(currUser.phone)
        setCity(currUser.city)
        if (currUser.driverLicense != null) {
            setDriverLicenseSerial(currUser.driverLicense.toString().slice(0, 4))
            setDriverLicenseNumber(currUser.driverLicense.toString().slice(4))
        }
    }, [currentUserState])

    useEffect(() => {
        console.log(birthDate)
        console.log(document.getElementById("dateChangeProfile"))
    }, [birthDate])

    const handleSaveSubmit = event => {
        event.preventDefault()
        const userState = currentUserState.currentUser

        const changedVariables = new Map()
        if (userState.firstName !== firstName)
            changedVariables.set('firstName', firstName)
        if (userState.lastName !== lastName)
            changedVariables.set('lastName', lastName)
        if (userState.middleName !== middleName)
            changedVariables.set('middleName', middleName)

        if (toIsoString(userState.birthDate) !== birthDate)
            changedVariables.set('birthDate', birthDate)
        if (userState.email !== email)
            changedVariables.set('email', email)
        if (userState.phone !== phoneNumber)
            changedVariables.set('phone', phoneNumber)

        if (userState.city !== city)
            changedVariables.set('city', city)
        if (userState.address !== address)
            changedVariables.set('address', address)
        if (userState.driverLicense !== driverLicenseSerial + driverLicenseNumber)
            changedVariables.set('driverLicense', driverLicenseSerial + driverLicenseNumber)

        console.log(changedVariables)
        doFetch({
            method: 'post',
            data: Object.fromEntries(changedVariables.entries())
        })
    }

    useEffect(() => {
        if (result != null) {
            console.log(result)
        }
    }, [result])

    const toIsoString = date => {
        const isoStr = new Date(date).toISOString()
        return isoStr.substring(0, isoStr.length - 1).split('T')[0]
    }



    return (
        <div>
            <section className="pers_date">
                <div className="container">
                    <h1 className="title4">Персональные данные</h1>
                    <form onSubmit={handleSaveSubmit} className="pers_date_form">
                        <div className="pers_date_row">
                            <div className="pers_date_item">
                                <label>Фамилия</label>
                                <input
                                    type="text"
                                    placeholder="Иванов"
                                    value={lastName}
                                    onChange={e => setLastName(e.target.value)}
                                />
                            </div>
                            <div className="pers_date_item">
                                <label>Электронная почта</label>
                                <input
                                    type="email"
                                    placeholder="valerii.ivanov.k@mail.ru"
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                />
                            </div>
                            <div className="pers_date_item">
                                <label>Водительское удостоверение: серия</label>
                                <input
                                    type="text"
                                    placeholder="0206"
                                    maxLength={4}
                                    minLength={4}
                                    value={driverLicenseSerial}
                                    onChange={e => setDriverLicenseSerial(e.target.value)}
                                />
                            </div>
                            <div className="pers_date_item">
                                <label>Водительское удостоверение: номер</label>
                                <input
                                    type="text"
                                    placeholder="526339"
                                    minLength={6}
                                    maxLength={6}
                                    value={driverLicenseNumber}
                                    onChange={e => setDriverLicenseNumber(e.target.value)}
                                />
                            </div>
                        </div>
                        <div className="pers_date_row">
                            <div className="pers_date_item">
                                <label>Имя</label>
                                <input
                                    type="text"
                                    placeholder="Валерий"
                                    value={firstName}
                                    onChange={e => setFirstName(e.target.value)}
                                />
                            </div>
                            <div className="pers_date_item">
                                <label>Номер телефона</label>
                                <input
                                    type="tel"
                                    placeholder="+7 (917) 487-85-85"
                                    value={phoneNumber}
                                    onChange={e => setPhoneNumber(e.target.value)}
                                />
                            </div>
                        </div>
                        <div className="pers_date_row">
                            <div className="pers_date_item">
                                <label>Отчество</label>
                                <input
                                    type="text"
                                    placeholder="Константинович"
                                    value={middleName}
                                    onChange={e => setMiddleName(e.target.value)}
                                />
                            </div>
                            <div className="pers_date_item">
                                <label>Город</label>
                                <input
                                    type="text"
                                    placeholder="Уфа"
                                    value={city}
                                    onChange={e => setCity(e.target.value)}
                                />
                            </div>
                        </div>
                        <div className="pers_date_row last">
                            <div className="pers_date_item">
                                <label>Дата рождения</label>
                                <input
                                    id={"dateChangeProfile"}
                                    type="date"
                                    placeholder="21.12.1998"
                                    max={"2015-12-31"}
                                    min={"1920-01-01"}
                                    value={birthDate}
                                    onChange={e => setBirthDate(e.target.value)}
                                />
                            </div>
                            <div className="pers_date_item">
                                <label>Адрес</label>
                                <input
                                    type="text"
                                    placeholder="ул. Академика Королева, д.18"
                                    value={address}
                                    onChange={e => setAddress(e.target.value)}
                                />
                            </div>
                        </div>
                        <input type={'submit'} style={{cursor: "pointer"}} value="Сохранить изменения"
                               className="hover2"/>
                    </form>
                </div>
            </section>
        </div>
    )
}

export default PersonalInfo
