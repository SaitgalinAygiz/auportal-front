import React, {useEffect, useState} from 'react'
import useFetch from "hooks/useFetch";
import Loading from "components/loading"
import Error from "components/errorMessage"
import {Map, Placemark} from 'react-yandex-maps'
import {serverUrl, transformWorkSchedule} from 'utils'
import axios from "axios";
import Slider from 'react-slick'

const Store = ({match, location}) => {
    const slug = match.params.slug
    const apiUrl = `/autostore/autostore/?id=${slug}`
    const [{response, isLoading, error}, doFetch] = useFetch(apiUrl)
    const [coordinates, setCoordinates] = useState(null)
    const [geoAddress, setGeoAddress] = useState('Уфа')
    const [licenses, setLicenses] = useState([])

    const [slickSettings, setSlickSettings] = useState({
        dots: true,
        speed: 500,
        arrow: true,
        slidesToShow: 6,
        slidesToScroll: 6
    })

    useEffect(() => {
        doFetch()
    }, [doFetch])

    const handleGetPdf = event => {
        const FileDownload = require('js-file-download')
        const apiUrl = `${serverUrl}/subAccount/getPriceList/?subAccountId=${response.id}`
        axios.get(apiUrl)
            .then(res => {
                FileDownload(res.data, 'price-list.pdf')
            })
            .catch(error => {
                console.log('error', error)
            })
    }

    const geocode = (ymaps) => {
        ymaps.geocode(geoAddress)
            .then(result => {
                setCoordinates(result.geoObjects.get(0).geometry.getCoordinates())
            })
    }

    const passengers = (services) => {
        return services.filter(service => service.autoType === 'passenger')
    }

    const trucks = (services) => {
        return services.filter(service => service.autoType === 'truck')
    }

    return (
        <section className="b1">
            <div className="container">
                {isLoading && <Loading/>}
                {error && <Error/>}
                {!isLoading && response && (
                    <>
                        <div className="b1c1">
                            <h2>О магазине автозапчастей</h2>

                        </div>

                        <div className="b1c2 c1c2">
                            <div className="b1c2_item">
                                <div className="b1c2_item_row">
                                    {response.photos.map((photo, index) => (
                                        <div className="b1c2_item_l_img" key={index}>
                                            <img
                                                src={`http://localhost:3999/subaccount-photo/subAccountPhotoByPath?path=${photo.path}`}
                                                alt={"AutoStorePhoto"}
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="b1c2_item">
                                <h1>{response.title}</h1>
                                <p>{response.description}</p>
                            </div>
                        </div>

                        {response.services.length > 0 && (
                            <>
                                <div className="c1c1">
                                    <h2 className="title3">Автозапчасти для марок автомобилей:</h2>
                                    {passengers(response.services).length !== 0 && (
                                        <h2 className="title2">Легковые автомобили</h2>
                                    )}

                                    <div className="c1c1_row">
                                        {passengers(response.services)
                                            .map((service, index) => (
                                                <div className="c1c1_item" key={index}>
                                                    <div className="c1c1_item_img">
                                                        <img
                                                            src={`http://localhost:3999/auto/getAutoIcon?autoTitle=${service.title}`}
                                                            alt={"service img"}
                                                        />
                                                    </div>
                                                    <h3>{service.title}</h3>
                                                </div>
                                            ))}

                                    </div>
                                </div>


                                <div className="c1c1">
                                    {trucks(response.services).length !== 0 && (
                                        <h2 className="title2" style={{marginTop: '-60px'}}>Грузовые автомобили</h2>
                                    )}
                                    <div className="c1c1_row">
                                        {trucks(response.services)
                                            .map((service, index) => (
                                                <div className="c1c1_item" key={index}>
                                                    <div className="c1c1_item_img">
                                                        <img
                                                            src={`http://localhost:3999/auto/getAutoIcon?autoTitle=${service.title}`}
                                                            alt={"service img"}
                                                        />
                                                    </div>
                                                    <h3>{service.title}</h3>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                            </>
                        )}

                        <div className="c1c1">
                            <div className="b1c3_down">
                                <p style={{cursor: "pointer"}} onClick={handleGetPdf}>Скачать прайс-лист в PDF
                                    <img src="/img/pdf.svg" alt={'pdf'}/></p>
                                <a href="return false;">Записаться в сервис</a>
                            </div>
                        </div>


                        {response.licenses.length !== 0 && (
                            <div className="b1c9">
                                <h2 className="title2">Лицензии, сертификаты, награды</h2>
                                <Slider {...slickSettings} >
                                    {response.licenses.map((license, index) => (
                                        <a key={index} className="b1c9_item"
                                           href={`http://localhost:3999/subaccount-photo/subAccountPhotoByPath?path=${license.path}`}>
                                            <img
                                                src={`http://localhost:3999/subaccount-photo/subAccountPhotoByPath?path=${license.path}`}
                                            />
                                        </a>
                                    ))}
                                </Slider>
                            </div>
                        )}


                        <div className="b1c10">
                            <h2 className="title2">Мы в социальных сетях</h2>
                            <div className="b1c10_row">
                                <div className="item">
                                    <a href={`https://${response.contacts.social.vk}`}>Перейти</a>
                                </div>
                                <div className="item">
                                    <a href={`https://${response.contacts.social.inst}`}>Перейти</a>
                                </div>
                                <div className="item">
                                    <a href={`https://${response.contacts.social.fb}`}>Перейти</a>
                                </div>
                                <div className="item">
                                    <a href={`https://${response.contacts.social.ok}`}>Перейти</a>
                                </div>
                            </div>
                        </div>
                        <div className="b1c5">
                            <h3 className="title2">Контакты</h3>
                            <div className="b1c5_row">
                                <div className="b1c5_item">
                                    <div className="b1c5_item_cont">
                                        <div className="b1c5_item_cont_toun">
                                            <div className="block-top">
                                                <div className="mide st1 town-row">
                                                    <span className="location"><a href="#">Уфа</a></span>
                                                </div>
                                            </div>
                                        </div>
                                        <p className="b1c5_item_cont_adr">{`ул.${response.contacts.addresses[0].street}, ${response.contacts.addresses[0].houseNumber}`}</p>
                                        <a className="b1c5_item_cont_tel"
                                           href="tel:+7 347 123 45 56">{response.contacts.phoneNumber}</a>
                                        <a className="b1c5_item_cont_site" href="https://мфпц.рф"
                                           target="_blank">{response.contacts.website}</a>
                                        <a className="b1c5_item_cont_mail" href="mailto:info@мфпц.рф">info@auto.com</a>
                                        <p className="b1c5_item_cont_time">
                                            {transformWorkSchedule(response.contacts.workScheduleFrom)}-
                                            {transformWorkSchedule(response.contacts.workScheduleTo) + ' '}
                                            09:00 - 18:00
                                        </p>
                                    </div>
                                </div>
                                <div className="b1c5_item">
                                    <Map
                                        onLoad={ymaps => geocode(ymaps)}
                                        modules={['geocode']}
                                        width={'100%'}
                                        height={420}
                                        defaultState={{center: [55.75, 37.57], zoom: 9}}
                                    >
                                        {coordinates && (
                                            <Placemark geometry={coordinates}/>
                                        )}

                                    </Map>
                                </div>
                            </div>
                        </div>

                    </>
                )}

            </div>
        </section>

    )
}

export default Store
